name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  quality:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Run tests with coverage
        run: npm run test:coverage
        env:
          VITE_SUPABASE_URL: https://placeholder.supabase.co
          VITE_SUPABASE_ANON_KEY: placeholder-anon-key
          VITE_APP_NAME: Unilien

      - name: Commentaire coverage sur la PR
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const fs = require('fs');
            const summaryPath = './coverage/coverage-summary.json';

            if (!fs.existsSync(summaryPath)) {
              console.log('Fichier coverage-summary.json introuvable, passage ignorÃ©.');
              return;
            }

            const { total } = JSON.parse(fs.readFileSync(summaryPath, 'utf8'));

            const fmt  = (m) => `${m.pct.toFixed(1)}% (${m.covered}/${m.total})`;
            const icon = (m) => m.pct >= 60 ? 'ðŸŸ¢' : m.pct >= 40 ? 'ðŸŸ¡' : 'ðŸ”´';

            const body = [
              '<!-- unilien-coverage-comment -->',
              '## ðŸ§ª Couverture de Tests',
              '',
              '| MÃ©trique | Couverture | Statut |',
              '|----------|-----------|:------:|',
              `| **Statements** | ${fmt(total.statements)} | ${icon(total.statements)} |`,
              `| **Branches**   | ${fmt(total.branches)}   | ${icon(total.branches)}   |`,
              `| **Functions**  | ${fmt(total.functions)}  | ${icon(total.functions)}  |`,
              `| **Lines**      | ${fmt(total.lines)}      | ${icon(total.lines)}      |`,
              '',
              '> ðŸŸ¢ â‰¥ 60% Â· ðŸŸ¡ â‰¥ 40% Â· ðŸ”´ < 40% â€” Cible Q2 : **60%**',
              '',
              '_GÃ©nÃ©rÃ© automatiquement par GitHub Actions_',
            ].join('\n');

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existing = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('<!-- unilien-coverage-comment -->')
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }

      - name: Build (vÃ©rification bundle)
        run: npm run build
        env:
          VITE_SUPABASE_URL: https://placeholder.supabase.co
          VITE_SUPABASE_ANON_KEY: placeholder-anon-key
          VITE_APP_NAME: Unilien
          VITE_APP_URL: http://localhost:5173

      - name: Commentaire taille du build sur la PR
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            function getDirSize(dirPath) {
              if (!fs.existsSync(dirPath)) return 0;
              return fs.readdirSync(dirPath).reduce((acc, file) => {
                const stats = fs.statSync(path.join(dirPath, file));
                return acc + (stats.isDirectory() ? getDirSize(path.join(dirPath, file)) : stats.size);
              }, 0);
            }

            const bytes = getDirSize('./dist');
            if (bytes === 0) {
              console.log('Dossier dist introuvable â€” build probablement en erreur.');
              return;
            }

            const body =
              `<!-- unilien-build-comment -->\n` +
              `## ðŸ“¦ Taille du Build\n\n` +
              `| MÃ©trique | Valeur |\n` +
              `|----------|--------|\n` +
              `| **Taille totale** | ${(bytes / (1024 * 1024)).toFixed(2)} MB |\n` +
              `| **Build** | âœ… SuccÃ¨s |\n\n` +
              `_GÃ©nÃ©rÃ© automatiquement par GitHub Actions_`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existing = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('<!-- unilien-build-comment -->')
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }

  accessibility:
    name: Accessibility Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run accessibility tests
        run: npm run test:run
        continue-on-error: true
        env:
          VITE_SUPABASE_URL: https://placeholder.supabase.co
          VITE_SUPABASE_ANON_KEY: placeholder-anon-key
          VITE_APP_NAME: Unilien
