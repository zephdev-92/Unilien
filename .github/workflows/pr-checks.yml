name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]
    
permissions:
  contents: read
  issues: write
  pull-requests: write
  
jobs:
  quality:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Pour l'analyse complÃ¨te

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Check bundle size
        run: npm run build

      - name: Comment PR with build size
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Fonction pour obtenir la taille d'un rÃ©pertoire
            function getDirSize(dirPath) {
              let size = 0;
              const files = fs.readdirSync(dirPath);
              
              files.forEach(file => {
                const filePath = path.join(dirPath, file);
                const stats = fs.statSync(filePath);
                
                if (stats.isDirectory()) {
                  size += getDirSize(filePath);
                } else {
                  size += stats.size;
                }
              });
              
              return size;
            }
            
            // Obtenir la taille du build
            const distPath = './dist';
            if (fs.existsSync(distPath)) {
              const sizeInBytes = getDirSize(distPath);
              const sizeInKB = (sizeInBytes / 1024).toFixed(2);
              const sizeInMB = (sizeInBytes / (1024 * 1024)).toFixed(2);
              
              const comment = `## ðŸ“¦ Build Size Report\n\n` +
                `- **Total size**: ${sizeInMB} MB (${sizeInKB} KB)\n` +
                `- **Build successful**: âœ…\n\n` +
                `_This comment is automatically generated by GitHub Actions._`;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

  accessibility:
    name: Accessibility Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build
        env:
          VITE_SUPABASE_URL: "https://placeholder.supabase.co"
          VITE_SUPABASE_ANON_KEY: "placeholder-key"
          VITE_APP_NAME: Handi-Lien
          VITE_APP_URL: "http://localhost:5173"

      - name: Run accessibility tests
        run: npm run test:run
        continue-on-error: true
